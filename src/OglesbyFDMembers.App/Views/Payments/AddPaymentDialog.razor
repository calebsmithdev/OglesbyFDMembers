@using System.ComponentModel.DataAnnotations
@using OglesbyFDMembers.App.Services
@using OglesbyFDMembers.Domain.Enums
@inject Radzen.DialogService Dialogs
@inject Radzen.NotificationService Notifications
@inject OglesbyFDMembers.App.Services.PaymentsService Payments
@inject OglesbyFDMembers.App.Services.PeopleService People
@implements IDisposable

<div class="rz-py-5">
    <RadzenTemplateForm TItem="AddPaymentModel" Data="model" Submit="HandleValidSubmit">
        <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Year" Style="width:100%" AllowFloatingLabel="false">
                    <ChildContent>
                        <RadzenDropDown Data="years" @bind-Value="selectedYear" TValue="int"
                                        Change="@(async _ => await OnYearAfterChange())"
                                        Placeholder="Select year" Style="width:100%" />
                    </ChildContent>
                </RadzenFormField>

                <RadzenFormField Text="Amount" Style="width:100%" AllowFloatingLabel="false">
                    <ChildContent>
                        <RadzenNumeric @bind-Value="model.Amount" Name="Amount" Placeholder="Amount" />
                    </ChildContent>
                    <Helper>
                        <RadzenRequiredValidator Component="Amount" Text="Amount is required" />
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Payment Type" Style="width:100%" AllowFloatingLabel="false">
                    <ChildContent>
                        <RadzenDropDown Data="paymentTypeOptions" @bind-Value="model.PaymentType" TValue="PaymentType"
                                        TextProperty="Text" ValueProperty="Value" Placeholder="Select type" Style="width:100%" />
                    </ChildContent>
                </RadzenFormField>

                <RadzenFormField Text="Paid Date (optional)" Style="width:100%" AllowFloatingLabel="false">
                    <ChildContent>
                        <InputDate class="form-control" @bind-Value="model.PaidDate" />
                    </ChildContent>
                </RadzenFormField>

                @if (model.PaymentType == PaymentType.Check)
                {
                    <RadzenFormField Text="Check # (optional)" Style="width:100%" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="model.CheckNumber" Name="CheckNumber" Placeholder="Check # (optional)" />
                        </ChildContent>
                    </RadzenFormField>
                }

                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" class="rz-pt-3">
                    <RadzenSwitch @bind-Value="model.IsDonation" Name="IsDonation" />
                    <RadzenLabel Text="Donation" Component="True" />
                </RadzenStack>

                @if (!model.IsDonation)
                {
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" class="rz-pt-3">
                        <RadzenSwitch @bind-Value="IsSingle" Name="AllocationIsSingle" Disabled="@(assessments.Count == 0)" />
                        <RadzenLabel Text="Apply to single assessment" Component="True" />
                    </RadzenStack>

                    @if (model.Mode == AllocationMode.SingleAssessment)
                    {
                        <RadzenFormField Text="Assessment" Style="width:100%" AllowFloatingLabel="false">
                            <ChildContent>
                                <RadzenDropDown Data="assessmentDropOptions" @bind-Value="model.TargetAssessmentId" TValue="int?"
                                                TextProperty="Text" ValueProperty="Value" AllowClear="true" Placeholder="Select…" Style="width:100%" />
                            </ChildContent>
                        </RadzenFormField>
                    }

                    <div class="text-muted" style="font-size:0.9rem;">
                        @AllocationHelp
                    </div>
                }

                <RadzenFormField Text="Notes" Style="width:100%" AllowFloatingLabel="false">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="model.Notes" Name="Notes" Placeholder="Notes (optional)" Rows="3" />
                    </ChildContent>
                </RadzenFormField>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="10px" class="rz-mt-4">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => Dialogs.CloseSide(false))" />
                <RadzenButton Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Type="ButtonType.Submit" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</div>

@code {
    [Parameter]
    public int PersonId { get; set; }

    private AddPaymentModel model = new()
    {
        PaymentType = PaymentType.Cash
    };

    private List<OglesbyFDMembers.App.Services.AssessmentOption> assessments = new();
    private List<Option<int>> assessmentDropOptions = new();
    private List<int> years = new();
    private int selectedYear;
    private readonly List<Option<PaymentType>> paymentTypeOptions = new()
    {
        new Option<PaymentType>("Cash", PaymentType.Cash),
        new Option<PaymentType>("Check", PaymentType.Check),
        new Option<PaymentType>("VVEC", PaymentType.VVEC)
    };

    private CancellationTokenSource _cts = new();
    private bool _disposed;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _disposed) return;
        try
        {
            years = await People.GetAvailableYearsAsync(_cts.Token);
            var currentYear = DateTime.UtcNow.Year;
            selectedYear = years.Contains(currentYear) ? currentYear : years.FirstOrDefault();
            if (selectedYear == 0) selectedYear = currentYear;
            assessments = await Payments.ListAssessmentOptionsAsync(PersonId, selectedYear, _cts.Token);
            assessmentDropOptions = assessments
                .Select(a => new Option<int>(FormatAssessment(a), a.AssessmentId))
                .ToList();
        }
        catch (OperationCanceledException)
        {
            return;
        }
        if (!_disposed)
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleValidSubmit(AddPaymentModel _)
    {
        try
        {
            var req = new OglesbyFDMembers.App.Services.AddPaymentRequest
            {
                PersonId = PersonId,
                Amount = model.Amount,
                PaymentType = model.PaymentType,
                PaidDateUtc = model.PaidDate?.ToUniversalTime(),
                CheckNumber = model.PaymentType == PaymentType.Check ? model.CheckNumber : null,
                IsDonation = model.IsDonation,
                Notes = model.Notes,
                AllocationMode = model.IsDonation ? null : model.Mode,
                AllocationYear = selectedYear,
                TargetAssessmentId = model.IsDonation || model.Mode != AllocationMode.SingleAssessment ? null : model.TargetAssessmentId
            };

            // Create and allocate based on selection
            await Payments.CreateAndAllocateAsync(req);

            Notifications.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Payment added",
                Duration = 3000
            });

            await Dialogs.CloseSideAsync(true);
        }
        catch (Exception ex)
        {
            Notifications.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Failed to add payment",
                Detail = ex.Message,
                Duration = 5000
            });
        }
    }

    private async Task ReloadAssessments()
    {
        try
        {
            assessments = await Payments.ListAssessmentOptionsAsync(PersonId, selectedYear, _cts.Token);
            assessmentDropOptions = assessments
                .Select(a => new Option<int>(FormatAssessment(a), a.AssessmentId))
                .ToList();
        }
        catch (OperationCanceledException)
        {
            return;
        }
        if (model.Mode == AllocationMode.SingleAssessment)
        {
            // clear target if year changed
            model.TargetAssessmentId = null;
        }
        if (assessments.Count == 0)
        {
            // No assessments for selected year (likely future). Force split mode.
            model.Mode = AllocationMode.SplitAcrossAll;
        }
    }

    private async Task OnYearAfterChange()
    {
        await ReloadAssessments();
        if (!_disposed)
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;
        try { _cts.Cancel(); } catch { }
        _cts.Dispose();
    }

    private record Option<T>(string Text, T Value);

    private bool IsSingle
    {
        get => model.Mode == AllocationMode.SingleAssessment;
        set => model.Mode = value ? AllocationMode.SingleAssessment : AllocationMode.SplitAcrossAll;
    }

    private class AddPaymentModel
    {
        [Required]
        [Range(0.01, 1000000)]
        public decimal Amount { get; set; }

        [Required]
        public PaymentType PaymentType { get; set; } = PaymentType.Cash;

        public DateTime? PaidDate { get; set; }
        public string? CheckNumber { get; set; }
        public bool IsDonation { get; set; }
        public string? Notes { get; set; }

        public AllocationMode Mode { get; set; } = AllocationMode.SplitAcrossAll;
        public int? TargetAssessmentId { get; set; }
    }

    private string FormatAssessment(OglesbyFDMembers.App.Services.AssessmentOption a)
    {
        var addr = a.Address;
        var citystate = string.Join(" ", new[] { a.City, a.State, a.Zip }.Where(s => !string.IsNullOrWhiteSpace(s)));
        if (!string.IsNullOrWhiteSpace(citystate)) addr += ", " + citystate;
        return $"{addr} — Balance: {a.Balance:C}";
    }

    private RenderFragment AllocationHelp => builder =>
    {
        var seq = 0;
        if (assessments.Count == 0)
        {
            builder.AddContent(seq++, "No assessments exist for the selected year. The payment will be recorded now and auto-applied when that year begins.");
        }
        else
        {
            builder.AddContent(seq++, "By default, payments are split proportionally across all selected-year open assessments. Selecting a specific assessment targets only that property.");
        }
    };
}
