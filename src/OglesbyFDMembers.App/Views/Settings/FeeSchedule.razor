@page "/settings/fee-schedule"
@using OglesbyFDMembers.App.Services
@inject FeeScheduleService FeeSvc
@inject NotificationService Notifications
@inject DialogService Dialogs
@inject NavigationManager Nav

<h1>Membership Dues</h1>
<p>
    Membership dues are expected to be paid on a daily basis and are calculated based on electricity service at a per property basis.
</p>

<div class="rz-mt-10">
    @if (existing?.Count > 0)
    {
        <RadzenDataGrid Data="@existing" TItem="OglesbyFDMembers.Domain.Entities.FeeSchedule" AllowPaging PageSize="10" RowHeight="34">
            <Columns>
                <RadzenDataGridColumn TItem="OglesbyFDMembers.Domain.Entities.FeeSchedule" Property="Year" Title="Year" Width="200px"/>
                <RadzenDataGridColumn TItem="OglesbyFDMembers.Domain.Entities.FeeSchedule" Title="Amount">
                    <Template Context="item">@item.AmountPerProperty.ToString("C")</Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="OglesbyFDMembers.Domain.Entities.FeeSchedule" Title="Actions" Width="200px">
                    <Template Context="item">
                        <RadzenButton Text="Edit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Icon="edit" Style="margin-right: .5rem;" Click="@(() => OpenEditDialog(item))"/>
                        <RadzenButton Text="Delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Icon="delete" Click="@(() => DeleteRow(item))"/>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
    else
    {
        <div class="text-muted rz-pt-5">No fee schedules have been set yet.</div>
    }
</div>

<!-- Floating Action Button -->
<RadzenButton Icon="add" ButtonStyle="ButtonStyle.Primary"
              Style="position: fixed; right: 24px; bottom: 24px; border-radius: 50%; width: 56px; height: 56px; box-shadow: var(--rz-shadow-2);"
              Click="@OpenAddDialog" />

@code {
    private List<OglesbyFDMembers.Domain.Entities.FeeSchedule>? existing;

    protected override async Task OnInitializedAsync()
    {
        await LoadList();
    }

    private async Task LoadList()
    {
        existing = await FeeSvc.ListAsync();
    }

    private async Task OpenAddDialog()
    {
        var result = await Dialogs.OpenAsync<AddFeeScheduleDialog>(
            "Add Fee Schedule",
            null,
            new DialogOptions
            {
                CloseDialogOnOverlayClick = true,
                ShowClose = true,
                Resizable = false,
                Draggable = false,
                Style = "width: 520px; max-width: 95vw;"
            });

        if (result is bool ok && ok)
        {
            await LoadList();
        }
    }

    private async Task OpenEditDialog(Domain.Entities.FeeSchedule f)
    {
        var result = await Dialogs.OpenAsync<EditFeeScheduleDialog>(
            "Edit Fee Schedule",
            new Dictionary<string, object?>
            {
                ["Year"] = f.Year,
                ["Amount"] = f.AmountPerProperty
            },
            new DialogOptions
            {
                CloseDialogOnOverlayClick = true,
                ShowClose = true,
                Resizable = false,
                Draggable = false,
                Style = "width: 520px; max-width: 95vw;"
            });

        if (result is bool ok && ok)
        {
            await LoadList();
        }
    }

    private async Task DeleteRow(Domain.Entities.FeeSchedule f)
    {
        try
        {
            var confirm = await Dialogs.Confirm(
                $"Delete fee schedule for {f.Year}? This cannot be undone.",
                "Delete Fee Schedule",
                new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

            if (confirm != true) return;

            await FeeSvc.DeleteAsync(f.Id);
            await LoadList();
            Notifications.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Deleted",
                Detail = $"Fee for {f.Year} deleted.",
                Duration = 2500
            });
        }
        catch (Exception ex)
        {
            Notifications.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = ex.Message,
                Duration = 6000
            });
        }
    }

}
