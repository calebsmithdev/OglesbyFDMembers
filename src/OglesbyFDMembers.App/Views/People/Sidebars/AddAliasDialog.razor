@using System.ComponentModel.DataAnnotations
@using OglesbyFDMembers.Domain.Entities
@inject DialogService Dialogs
@inject NotificationService Notifications
@inject Services.PeopleService People

<div class="rz-py-5">
    <RadzenTemplateForm TItem="AddAliasModel" Data="model" Submit="HandleSubmit">
        <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Alias" Style="width:100%" AllowFloatingLabel="false">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="model.Alias" Name="Alias" Placeholder="Alias (e.g., First Last, Business name)"/>
                    </ChildContent>
                    <Helper>
                        <RadzenRequiredValidator Component="Alias" Text="Alias is required"/>
                    </Helper>
                </RadzenFormField>
                <RadzenFormField Text="Type" Style="width:100%" AllowFloatingLabel="false">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="model.Type" Name="AliasType" Data="typeOptions"
                                        TValue="PersonAliasType" Placeholder="Select type"
                                        TextProperty="Text" ValueProperty="Value"/>
                    </ChildContent>
                    <Helper>
                        <RadzenRequiredValidator Component="AliasType" Text="Type is required"/>
                    </Helper>
                </RadzenFormField>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="10px" class="rz-mt-4">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => Dialogs.CloseSide(false))"/>
                <RadzenButton Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Type="ButtonType.Submit"/>
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</div>

@code {
    [Parameter]
    public int PersonId { get; set; }

    private AddAliasModel model = new();
    private readonly List<AliasTypeOption> typeOptions = new()
    {
        new AliasTypeOption { Text = "Family", Value = PersonAliasType.FamilyMember },
        new AliasTypeOption { Text = "VVEC", Value = PersonAliasType.VVEC },
        new AliasTypeOption { Text = "Other", Value = PersonAliasType.Other }
    };

    private async Task HandleSubmit(AddAliasModel _)
    {
        try
        {
            await People.AddAliasAsync(PersonId, model.Alias, model.Type);
            Notifications.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Alias added",
                Detail = "Alias has been added to the person.",
                Duration = 3000
            });
            await Dialogs.CloseSideAsync(true);
        }
        catch (Exception ex)
        {
            Notifications.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Failed to add alias",
                Detail = ex.Message,
                Duration = 5000
            });
        }
    }

    private class AddAliasModel
    {
        [Required, MaxLength(200)]
        public string Alias { get; set; } = string.Empty;
        [Required]
        public PersonAliasType Type { get; set; } = PersonAliasType.FamilyMember;
    }

    private class AliasTypeOption
    {
        public string Text { get; set; } = string.Empty;
        public PersonAliasType Value { get; set; }
    }
}

