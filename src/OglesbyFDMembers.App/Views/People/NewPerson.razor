@page "/members/new"
@using OglesbyFDMembers.App.Services
@using OglesbyFDMembers.Domain.Enums
@using System.ComponentModel.DataAnnotations
@inject IntakeService IntakeSvc
@inject Radzen.NotificationService Notifications
@inject IServiceProvider Services
@inject NavigationManager Nav

<RadzenRow JustifyContent="JustifyContent.Center">
    <RadzenColumn Size="12" SizeMD="8">
        <h1>New Member Intake</h1>
        <p class="rz-mb-8">
            All of the important information for a member can be entered below. You will be able to add more properties, mailing addresses, or additional payments later on.
        </p>
        
        <RadzenTemplateForm TItem="IntakeVm" Data="model" Submit="HandleSubmit">
            <DataAnnotationsValidator/>
            <ValidationSummary/>

            <RadzenFieldset Text="Contact" Style="margin-bottom:1rem;">
                <RadzenRow Gap="1rem" Wrap="FlexWrap.Wrap">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="First Name" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.FirstName" Name="FirstName" />
                            <RadzenRequiredValidator Component="FirstName" Text="First name is required"/>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Last Name" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.LastName" Name="LastName" />
                            <RadzenRequiredValidator Component="LastName" Text="Last name is required"/>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Phone (optional)" Style="width:100%">
                            <RadzenMask Mask="(***) ***-****" CharacterPattern="[0-9]" Placeholder="(000) 000-0000" Name="Phone" @bind-Value="model.Phone" aria-label="Phone"/>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Email (optional)" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.Email" Name="Email" />
                            <RadzenEmailValidator Component="Email" Text="Invalid email format"/>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenFieldset>

            <RadzenFieldset Text="Mailing Address" Style="margin-bottom:1rem;">
                <RadzenRow Gap="1rem" Wrap="FlexWrap.Wrap">
                    <RadzenColumn Size="12">
                        <RadzenFormField Text="Addressee Name (optional)" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.AddresseeName" Name="AddresseeName" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12">
                        <RadzenFormField Text="Address Line 1" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.AddressLine1" Name="AddressLine1" />
                            <RadzenRequiredValidator Component="AddressLine1" Text="Address Line 1 is required"/>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12">
                        <RadzenFormField Text="Address Line 2" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.AddressLine2" Name="AddressLine2" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="City" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.City" Name="City" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="2">
                        <RadzenFormField Text="State" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.State" Name="State" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Postal Code" Style="width:100%">
                            <RadzenTextBox @bind-Value="model.PostalCode" Name="PostalCode" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenFieldset>

            <RadzenFieldset Text="Property" Style="margin-bottom:1rem;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenSwitch @bind-Value="model.PropertySameAsAddress" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "Add separate property entry" }})" />
                    <RadzenLabel Text="Property address is same as mailing" Component="True" />
                </RadzenStack>
                @if (!model.PropertySameAsAddress)
                {
                    <RadzenRow Gap="1rem" Wrap="FlexWrap.Wrap" Style="margin-top: 1rem;">
                        <RadzenColumn Size="12">
                            <RadzenFormField Text="Address Line 1" Style="width:100%">
                                <RadzenTextBox @bind-Value="model.PropertyAddressLine1" Name="PropertyAddressLine1" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12">
                            <RadzenFormField Text="Address Line 2" Style="width:100%">
                                <RadzenTextBox @bind-Value="model.PropertyAddressLine2" Name="PropertyAddressLine2" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="City" Style="width:100%">
                                <RadzenTextBox @bind-Value="model.PropertyCity" Name="PropertyCity" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="2">
                            <RadzenFormField Text="State" Style="width:100%">
                                <RadzenTextBox @bind-Value="model.PropertyState" Name="PropertyState" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenFormField Text="Postal Code" Style="width:100%">
                                <RadzenTextBox @bind-Value="model.PropertyPostalCode" Name="PropertyPostalCode" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                }
            </RadzenFieldset>

            <RadzenFieldset Text="Payment" Style="margin-bottom:3rem;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenSwitch @bind-Value="model.HasPaid" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "Add a payment" }})" />
                    <RadzenLabel Text="Add a payment" Component="True" />
                </RadzenStack>
                @if (model.HasPaid)
                {
                    <RadzenRow Gap="1rem" Wrap="FlexWrap.Wrap" Style="margin-top: 1rem;">
                        <RadzenColumn Size="12">
                            <RadzenSelectBar @bind-Value="@model.PaymentType">
                                <Items>
                                    <RadzenSelectBarItem Value="@PaymentType.Cash" Text="Cash" />
                                    <RadzenSelectBarItem Value="@PaymentType.Check" Text="Check" />
                                    <RadzenSelectBarItem Value="@PaymentType.VVEC" Text="VVEC" />
                                </Items>
                            </RadzenSelectBar>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenFormField Text="Amount" Style="width:100%">
                                <RadzenNumeric @bind-Value="model.PaymentAmount" Name="PaymentAmount"/>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenFormField Text="Paid Date (optional)" Style="width:100%">
                                <RadzenDatePicker @bind-Value=@model.PaidDate Name="PaidDate" ShowCalendarWeek />
                            </RadzenFormField>
                        </RadzenColumn>
                        @if (model.PaymentType == PaymentType.Check)
                        {
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenFormField Text="Check # (optional)">
                                    <RadzenTextBox @bind-Value="model.CheckNumber" Name="CheckNumber" Style="width:100%"/>
                                </RadzenFormField>
                            </RadzenColumn>
                        }
                    </RadzenRow>
                }
            </RadzenFieldset>

            <div class="d-flex justify-content-end" style="margin-top: 1rem;">
                <RadzenButton Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Type="ButtonType.Submit"/>
            </div>
        </RadzenTemplateForm>
    </RadzenColumn>
</RadzenRow>

@code {
    private IntakeVm model = new();

    private async Task HandleSubmit(IntakeVm _)
    {
        // Validate conditional fields
        if (!model.PropertySameAsAddress && string.IsNullOrWhiteSpace(model.PropertyAddressLine1))
        {
            Notifications.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Warning,
                Summary = "Missing Property Address",
                Detail = "Property Address Line 1 is required when using a different property address.",
                Duration = 5000
            });
            return;
        }

        // Map to request
        var req = new IntakeRequest
        {
            FirstName = model.FirstName,
            LastName = model.LastName,
            Email = model.Email,
            Phone = model.Phone,
            AddresseeName = string.IsNullOrWhiteSpace(model.AddresseeName)
                ? string.Join(" ", new[] { model.FirstName, model.LastName }.Where(s => !string.IsNullOrWhiteSpace(s)))
                : model.AddresseeName,
            AddressLine1 = model.AddressLine1,
            AddressLine2 = model.AddressLine2,
            City = model.City,
            State = model.State,
            PostalCode = model.PostalCode,
            PropertySameAsAddress = model.PropertySameAsAddress,
            PropertyAddressLine1 = model.PropertySameAsAddress ? null : model.PropertyAddressLine1,
            PropertyAddressLine2 = model.PropertySameAsAddress ? null : model.PropertyAddressLine2,
            PropertyCity = model.PropertySameAsAddress ? null : model.PropertyCity,
            PropertyState = model.PropertySameAsAddress ? null : model.PropertyState,
            PropertyPostalCode = model.PropertySameAsAddress ? null : model.PropertyPostalCode,
            HasPaid = model.HasPaid,
            PaymentAmount = model.PaymentAmount,
            PaymentType = model.PaymentType,
            CheckNumber = model.CheckNumber,
            PaidDateUtc = model.PaidDate?.ToUniversalTime(),
            AssessmentYear = model.AssessmentYear,
            Notes = model.Notes
        };

        try
        {
            var id = await IntakeSvc.CreateAsync(req);
            Nav.NavigateTo($"/members/{id}");
        }
        catch (Exception ex)
        {
            Notifications.Notify(new Radzen.NotificationMessage
            {
                Severity = Radzen.NotificationSeverity.Error,
                Summary = "Error",
                Detail = ex.Message,
                Duration = 6000
            });
        }
    }

    private void Reset()
    {
        model = new IntakeVm();
    }

    private async Task OnHasPaidChanged(bool value)
    {
        model.HasPaid = value;
        if (value && (model.PaymentAmount is null || model.PaymentAmount == 0))
        {
            try
            {
                var amount = await IntakeSvc.GetFeeAmountAsync(model.AssessmentYear);
                model.PaymentAmount = amount;
            }
            catch (Exception ex)
            {
                Notifications.Notify(new Radzen.NotificationMessage
                {
                    Severity = Radzen.NotificationSeverity.Warning,
                    Summary = "Fee Lookup Failed",
                    Detail = ex.Message,
                    Duration = 4000
                });
            }
        }
    }

    private Task OnHasPaidAfterChange()
    {
        return OnHasPaidChanged(model.HasPaid);
    }

    private string? ComposePropertySitusAddress()
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(model.PropertyAddressLine1)) parts.Add(model.PropertyAddressLine1.Trim());
        if (!string.IsNullOrWhiteSpace(model.PropertyAddressLine2)) parts.Add(model.PropertyAddressLine2.Trim());

        var cityStatePostal = string.Join(" ", new[]
        {
            string.IsNullOrWhiteSpace(model.PropertyCity) ? null : model.PropertyCity!.Trim() + ",",
            string.IsNullOrWhiteSpace(model.PropertyState) ? null : model.PropertyState!.Trim(),
            string.IsNullOrWhiteSpace(model.PropertyPostalCode) ? null : model.PropertyPostalCode!.Trim()
        }.Where(s => !string.IsNullOrWhiteSpace(s)));

        if (!string.IsNullOrWhiteSpace(cityStatePostal)) parts.Add(cityStatePostal);
        return string.Join(", ", parts);
    }

    private class IntakeVm
    {
        // Person
        [Required, MaxLength(100)] public string FirstName { get; set; } = string.Empty;
        [Required, MaxLength(100)] public string LastName { get; set; } = string.Empty;
        [EmailAddress, MaxLength(200)] public string? Email { get; set; }
        [MaxLength(32)] public string? Phone { get; set; }

        // Address
        [MaxLength(200)] public string? AddresseeName { get; set; }
        [Required, MaxLength(200)] public string AddressLine1 { get; set; } = string.Empty;
        [MaxLength(200)] public string? AddressLine2 { get; set; }
        [MaxLength(100)] public string? City { get; set; }
        [MaxLength(64)] public string? State { get; set; }
        [MaxLength(32)] public string? PostalCode { get; set; }

        // Property
        public bool PropertySameAsAddress { get; set; } = true;
        [MaxLength(200)] public string? PropertyAddressLine1 { get; set; }
        [MaxLength(200)] public string? PropertyAddressLine2 { get; set; }
        [MaxLength(100)] public string? PropertyCity { get; set; }
        [MaxLength(64)] public string? PropertyState { get; set; }
        [MaxLength(32)] public string? PropertyPostalCode { get; set; }

        // Payment
        public bool HasPaid { get; set; }
        public decimal? PaymentAmount { get; set; }
        public PaymentType PaymentType { get; set; } = PaymentType.Cash;
        public string? CheckNumber { get; set; }
        public DateTime? PaidDate { get; set; }
        public int? AssessmentYear { get; set; }
        public string? Notes { get; set; }
    }
}
