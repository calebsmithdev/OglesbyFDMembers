@page "/members"
@using OglesbyFDMembers.App.Services
@inject PeopleService PeopleSvc
@inject NavigationManager Nav
@inject Radzen.NotificationService Notifications

<h1>People</h1>

<RadzenRow Wrap="FlexWrap.Wrap" Gap="1rem" Style="margin-bottom: 1rem; align-items:flex-end;">
    <RadzenColumn Size="12" SizeSM="8" SizeMD="6" SizeLG="4">
        <RadzenFormField Text="Year" Variant="Variant.Outlined" Style="width:100%">
            <ChildContent>
                <RadzenDropDown Data="years" @bind-Value="year" TValue="int" Style="width:100%"
                                 Placeholder="Select year" Change="@(async _ => await LoadAsync())"/>
            </ChildContent>
        </RadzenFormField>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeSM="8" SizeMD="6" SizeLG="4">
        <RadzenFormField Text="Search" Variant="Variant.Outlined" Style="width:100%">
            <ChildContent>
                <div style="display:flex; align-items:center; gap:.5rem; width:100%;">
                    <RadzenTextBox @bind-Value="search" Style="flex:1 1 auto; width:100%" Placeholder="Name or any address"
                                   Debounce="true" Delay="300"
                                   Change="@(async _ => await LoadAsync())" />
                    @if (!string.IsNullOrWhiteSpace(search))
                    {
                        <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@ClearSearch" Title="Clear" />
                    }
                    @if (loading)
                    {
                        <RadzenProgressBar ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width:60px;height:8px;" />
                    }
                </div>
            </ChildContent>
        </RadzenFormField>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeSM="8" SizeMD="6" SizeLG="4">
        <div style="display:flex; gap:.5rem; align-items:center;">
            <RadzenSplitButton Text="Export" Icon="download" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium"
                                Click="@(args => OnExportAction(args?.Value?.ToString()))">
                <ChildContent>
                    <RadzenSplitButtonItem Text="Export Mailing List (Excel)" Value="mailing-xlsx" Icon="download" />
                    <RadzenSplitButtonItem Text="Export Member List (Excel)" Value="member-xlsx" Icon="download" />
                </ChildContent>
            </RadzenSplitButton>
        </div>
    </RadzenColumn>
</RadzenRow>

<RadzenDataGrid @ref="grid" Data="people" TItem="PersonListItem" RowHeight="38" AllowSorting AllowPaging AllowFiltering="false" PageSize="25">
    <Columns>
        <RadzenDataGridColumn TItem="PersonListItem" Title="" Width="90px">
            <Template Context="item">
                <RadzenButton Text="View" Icon="visibility" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@(() => ViewPerson(item.PersonId))" />
            </Template>
            <HeaderTemplate>
                <span></span>
            </HeaderTemplate>
            <FooterTemplate>
                <span></span>
            </FooterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="PersonListItem" Property="FullName" Title="Name" Width="220px" />
        <RadzenDataGridColumn TItem="PersonListItem" Property="Address" Title="Address" Width="340px" />
        <RadzenDataGridColumn TItem="PersonListItem" Property="Phone" Title="Phone" Width="140px" />
        <RadzenDataGridColumn TItem="PersonListItem" Property="Email" Title="Email" Width="220px" />
        <RadzenDataGridColumn TItem="PersonListItem" Title="Payment Status">
            <Template Context="item">
                @PaymentStatusTemplate(item)
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private RadzenDataGrid<PersonListItem>? grid;
    private List<PersonListItem> people = new();
    private List<int> years = new();
    private int year;
    private string? search;
    private bool loading;
    [Inject] IJSRuntime JS { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        years = await PeopleSvc.GetAvailableYearsAsync();
        var currentYear = DateTime.UtcNow.Year;
        year = years.Contains(currentYear) ? currentYear : years.FirstOrDefault();
        if (year == 0) year = currentYear;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        loading = true;
        try
        {
            people = await PeopleSvc.ListAsync(year, search);
        }
        finally
        {
            loading = false;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task ClearSearch()
    {
        search = null;
        await LoadAsync();
    }

    private void ViewPerson(int personId)
    {
        Nav.NavigateTo($"/people/{personId}");
    }

    private async Task OnExportAction(string? val)
    {
        if (string.IsNullOrWhiteSpace(val)) return;
        try
        {
            if (val == "mailing-xlsx")
            {
                var bytes = await PeopleSvc.ExportMailingExcelAsync(year, search);
                var base64 = Convert.ToBase64String(bytes);
                var filename = $"mailing-list-{year}.xlsx";
                await JS.InvokeVoidAsync("downloadBase64", filename, base64, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
                Notifications.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Export ready", Detail = "Mailing list exported." });
            }
            else if (val == "member-xlsx")
            {
                var bytes = await PeopleSvc.ExportMemberExcelAsync(year, search);
                var base64 = Convert.ToBase64String(bytes);
                var filename = $"member-list-{year}.xlsx";
                await JS.InvokeVoidAsync("downloadBase64", filename, base64, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
                Notifications.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Export ready", Detail = "Member list exported." });
            }
        }
        catch (Exception ex)
        {
            Notifications.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Export failed", Detail = ex.Message });
        }
    }

    // CSV removed in favor of true Excel export as requested.

    private RenderFragment PaymentStatusTemplate(PersonListItem item) => builder =>
    {
        var seq = 0;
        // Paid amount
        builder.OpenElement(seq++, "span");
        builder.AddContent(seq++, $"{item.AmountPaid:C} ");
        builder.CloseElement();

        // Parentheses show AmountDue as a negative e.g. (-$20.00), in red.
        var style = "color:#b00020;font-weight:600"; // material red tone
        builder.OpenElement(seq++, "span");
        builder.AddAttribute(seq++, "style", style);
        builder.AddContent(seq++, $"(-{item.AmountDue:C})");
        builder.CloseElement();

        // Optional status label
        var label = item.Status switch
        {
            PaymentStatus.Paid => " Paid",
            PaymentStatus.Partial => " Partial",
            PaymentStatus.Unpaid => " Unpaid",
            _ => null
        };
        if (!string.IsNullOrWhiteSpace(label))
        {
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "style", "margin-left:6px;color:#666;font-size:0.85rem");
            builder.AddContent(seq++, label);
            builder.CloseElement();
        }
    };
}
