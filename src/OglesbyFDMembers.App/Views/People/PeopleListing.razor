@page "/members"
@using OglesbyFDMembers.App.Services
@inject PeopleSidebarService SidebarSvc
@inject PeopleService PeopleSvc
@inject NavigationManager Nav
@inject NotificationService Notifications

<h1>Members</h1>
<p class="rz-mb-8">
    Listing of people who are active and inactive members of Oglesby Fire Department.
</p>

<RadzenDataGrid Data="people" TItem="PersonListItem"
                AllowColumnResize AllowSorting AllowPaging ShowPagingSummary AllowColumnPicking
                ColumnWidth="300px" AllowFiltering PageSize="25">
    <HeaderTemplate>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem;" Wrap="FlexWrap.Wrap">
            <RadzenSplitButton Text="Export" Icon="download" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium"
                               Click="@(args => OnExportAction(args?.Value?.ToString()))">
                <ChildContent>
                    <RadzenSplitButtonItem Text="Export Mailing List (Excel)" Value="mailing-xlsx" Icon="download" />
                    <RadzenSplitButtonItem Text="Export Member List (Excel)" Value="member-xlsx" Icon="download" />
                </ChildContent>
            </RadzenSplitButton>
        </RadzenStack>
    </HeaderTemplate>
    <Columns>
        <RadzenDataGridColumn TItem="PersonListItem" Property="FirstName" Title="First Name" Width="180px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="LastName" Title="Last Name" Width="180px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="Line1" Title="Address Line 1" Width="280px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="Line2" Visible="false" Title="Address Line 2" Width="220px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="City" Title="City" Visible="false" Width="160px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="State" Title="State" Visible="false" Width="120px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="PostalCode" Title="Zip" Visible="false" Width="140px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="Phone" Title="Phone" Width="140px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="Email" Title="Email" Width="220px"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="PropertyCount" Title="# Properties" Width="120px" Visible="false"/>
        <RadzenDataGridColumn TItem="PersonListItem" Property="AddressCount" Title="# Addresses" Width="120px" Visible="false"/>
        <RadzenDataGridColumn TItem="PersonListItem" Title="Payment Status" Width="250px" Filterable="false">
            <Template Context="item">
                @PaymentStatusTemplate(item)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="PersonListItem" Title="" Width="100px" Frozen="true" ColumnPickerTitle="Actions" FrozenPosition="FrozenColumnPosition.Right" Filterable="false" Sortable="false" Resizable="false">
            <Template Context="item">
                <div @onclick:stopPropagation="true" style="display:flex; justify-content:flex-end;">
                    <RadzenSplitButton ButtonStyle="ButtonStyle.Light" Size="ButtonSize.ExtraSmall" Text="View" Value=""
                                       Click="@(args => OnClickViewDetails(item.PersonId, args?.Value?.ToString()))">
                        <ChildContent>
                            <RadzenSplitButtonItem Text="Add Alias" Value="add-alias" Icon="detection_and_zone"/>
                            <RadzenSplitButtonItem Text="Add Payment" Value="add-payment" Icon="payments"/>
                            <RadzenSplitButtonItem Text="Add Address" Value="add-address" Icon="home"/>
                            <RadzenSplitButtonItem Text="Add Property" Value="add-property" Icon="add_home"/>
                        </ChildContent>
                    </RadzenSplitButton>
                </div>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private List<PersonListItem> people = new();
    private List<int> years = new();
    private int year;
    private string? search;
    private bool loading;
    [Inject] IJSRuntime JS { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        years = await PeopleSvc.GetAvailableYearsAsync();
        var currentYear = DateTime.UtcNow.Year;
        year = years.Contains(currentYear) ? currentYear : years.FirstOrDefault();
        if (year == 0) year = currentYear;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        loading = true;
        try
        {
            people = await PeopleSvc.ListAsync(year, search);
        }
        finally
        {
            loading = false;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnExportAction(string? val)
    {
        if (string.IsNullOrWhiteSpace(val)) return;
        try
        {
            if (val == "mailing-xlsx")
            {
                var bytes = await PeopleSvc.ExportMailingExcelAsync(year, search);
                var base64 = Convert.ToBase64String(bytes);
                var filename = $"mailing-list-{year}.xlsx";
                await JS.InvokeVoidAsync("downloadBase64", filename, base64, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
                Notifications.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Export ready", Detail = "Mailing list exported." });
            }
            else if (val == "member-xlsx")
            {
                var bytes = await PeopleSvc.ExportMemberExcelAsync(year, search);
                var base64 = Convert.ToBase64String(bytes);
                var filename = $"member-list-{year}.xlsx";
                await JS.InvokeVoidAsync("downloadBase64", filename, base64, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
                Notifications.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Export ready", Detail = "Member list exported." });
            }
        }
        catch (Exception ex)
        {
            Notifications.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Export failed", Detail = ex.Message });
        }
    }

    // CSV removed in favor of true Excel export as requested.

    private RenderFragment PaymentStatusTemplate(PersonListItem item) => builder =>
    {
        var seq = 0;
        var label = item.Status switch
        {
            PaymentStatus.Paid => " Paid",
            PaymentStatus.Partial => " Partial",
            PaymentStatus.Unpaid => " Unpaid",
            _ => null
        };
        
        // Paid amount
        builder.OpenElement(seq++, "span");
        builder.AddContent(seq++, $"{label} ");
        builder.CloseElement();

        // Parentheses show AmountDue as a negative e.g. (-$20.00), in red.
        if (item.AmountDue > 0)
        {
            var style = "color:#b00020;font-weight:600"; // material red tone
            builder.OpenElement(seq++, "span");
            builder.AddAttribute(seq++, "style", style);
            builder.AddContent(seq++, $"(-{item.AmountDue:C})");
            builder.CloseElement();
        }
    };

    private async Task OnClickViewDetails(int personId, string? action)
    {
        switch (action)
        {
            case "add-alias":
                await OpenAddAliasDialog(personId);
                break;
            case "add-address":
                await OpenAddAddressSidebar(personId);
                break;
            case "add-property":
                await OpenAddPropertyDialog(personId);
                break;
            case "add-payment":
                await OpenAddPaymentDialog(personId);
                break;
            default:
                Nav.NavigateTo($"/members/{personId}");
                break;
        }
    }
    
    private async Task OpenAddPaymentDialog(int personId)
    {
        var ok = await SidebarSvc.OpenAddPaymentDialog(personId);
        if (ok) await LoadAsync();
    }

    private async Task OpenAddPropertyDialog(int personId)
    {
        var ok = await SidebarSvc.OpenAddPropertyDialog(personId);
        if (ok) await LoadAsync();
    }

    private async Task OpenAddAliasDialog(int personId)
    {
        var ok = await SidebarSvc.OpenAddAliasDialog(personId);
        if (ok) await LoadAsync();
    }
    
    private async Task OpenAddAddressSidebar(int personId)
    {
        var ok = await SidebarSvc.OpenAddAddressSidebar(personId);
        if (ok) await LoadAsync();
    }
}
